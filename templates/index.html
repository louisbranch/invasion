<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" charset="utf-8" src="/assets/js/protocol/flatbuffers.js"></script>
    <script type="text/javascript" charset="utf-8" src="/assets/js/protocol/client_generated.js"></script>
    <script type="text/javascript" charset="utf-8" src="/assets/js/protocol/server_generated.js"></script>
    <title>Invasion</title>
  </head>
  <body>
    <h1>Invasion</h1>
    <div>
      <textarea id="chat-log" rows="8" cols="40" disabled></textarea>
      <input type="text" name="message" id="chat" placeholder="type your msg...">
    </div>

    <script type="text/javascript" charset="utf-8">
      (function(window, document) {
        var ws = new WebSocket("ws://localhost:8080/ws");
        var log = document.getElementById("chat-log");
        var chat = document.getElementById("chat");

        ws.addEventListener("open", function() {
          var builder = new flatbuffers.Builder(0);
          var name = builder.createString("luiz");
          var email = builder.createString("me@luizbranco.com");
          client.CreateAccount.startCreateAccount(builder);
          client.CreateAccount.addName(builder, name);
          client.CreateAccount.addEmail(builder, email);
          var create = client.CreateAccount.endCreateAccount(builder);

          client.Message.startMessage(builder);
          client.Message.addRequestType(builder, client.Request.CreateAccount);
          client.Message.addRequest(builder, create);
          var msg = client.Message.endMessage(builder);

          builder.finish(msg);

          var buf =  builder.asUint8Array();

          ws.send(buf);
        });

        ws.addEventListener("message",function(event) {
          var fileReader = new FileReader();

          fileReader.onload = function() {
            var buffer = this.result;
            var data  = new Uint8Array(buffer);
            var builder = new flatbuffers.ByteBuffer(data);
            var msg = server.Message.getRootAsMessage(builder);

            var unionType = msg.responseType();

            if (msg.response(unionType)) {
              switch (unionType) {
                case server.Response.ChatMessage:
                  var c = msg.response(new server.ChatMessage());
                  log.value += c.message() + "\n";
                  break;
                default:
                  console.log("Unknown respose type", unionType);
              }
            }
          }

          fileReader.readAsArrayBuffer(event.data);
        });

        chat.addEventListener("keyup", function(event) {
          var val = chat.value.trim();
          if (event.keyCode == 13 && val.length != 0) {
            var builder = new flatbuffers.Builder(0);
            var id = builder.createString("123");
            var txt = builder.createString(val);
            client.ChatMessage.startChatMessage(builder);
            client.ChatMessage.addGameId(builder, id);
            client.ChatMessage.addMessage(builder, txt);
            var chatMsg = client.ChatMessage.endChatMessage(builder);

            client.Message.startMessage(builder);
            client.Message.addRequestType(builder, client.Request.ChatMessage);
            client.Message.addRequest(builder, chatMsg);
            var msg = client.Message.endMessage(builder);

            builder.finish(msg);

            var buf =  builder.asUint8Array();

            ws.send(buf);

            chat.value = "";
          }
        });

      }(window, document));
    </script>
  </body>
</html>
